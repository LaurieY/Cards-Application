<!DOCTYPE html>
<html>

<head>

<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 14 (filtered)">
<link href="css/style.css" rel="stylesheet" type="text/css" media="screen">
<link href="css/style_print.css" rel="stylesheet" type="text/css" media="print">

<script type="text/javascript" src="js/jquery-2.1.0.js"></script> 

<script type="text/javascript" src="js/jspdf.source.js"></script>

<script type="text/javascript" src="js/makeCards.js"></script>


<script type="text/javascript" src="js/xls.js"></script>

<style>
#drop{
	border:2px dashed #bbb;
	-moz-border-radius:5px;
	-webkit-border-radius:5px;
	border-radius:5px;
	padding:25px;
	text-align:center;
	font:20pt bold,"Vollkorn";color:#bbb
}
#b64data{
	width:100%;
}

</style>

</head>
<body lang=EN-GB>
<script> 
$(document).ready(function() { 

$('.preview-pane').attr('src','frame.html');
//$('.grid-pane').attr('src','grid.html');
 $("button[value='makeCards']").click(function() { 
  createCards("show"); 
 }); 
  $("button[value='printCards']").click(function() { 

  createCards("print"); 
 }); 

function xlsworker(data, cb) {
	var worker = new Worker("js/xlsworker.js");
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d);
			case 'xls': cb(e.data.d); break;
		}
	};
	worker.postMessage(data);
}

function get_radio_value( radioName ) {
	var radios = document.getElementsByName( radioName );
	for( var i = 0; i < radios.length; i++ ) {
		if( radios[i].checked ) {
			return radios[i].value;
		}
	}
}

function to_json(workbook) {
	var result = {};
	workbook.SheetNames.forEach(function(sheetName) {
		//var roa = XLS.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
	var roa =	sheet_to_row_object_array_add_headings(workbook.Sheets[sheetName],["c1","c2","c3","c4","c5","c6","c7","c8","c9","c10"]);
		if(roa.length > 0){
			result[sheetName] = roa;
		}
	});
	return result;
}

function to_csv(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var csv = XLS.utils.make_csv(workbook.Sheets[sheetName]);
		if(csv.length > 0){
			result.push("SHEET: " + sheetName);
			result.push("");
			result.push(csv);
		}
	});
	return result.join("\n");
}

function to_formulae(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var formulae = XLS.utils.get_formulae(workbook.Sheets[sheetName]);
		if(formulae.length > 0){
			result.push("SHEET: " + sheetName);
			result.push("");
			result.push(formulae.join("\n"));
		}
	});
	return result.join("\n");
}

var tarea = document.getElementById('b64data');
function b64it() {
	var cfb = XLS.CFB.read(tarea.value, {type: 'base64'});
	var wb = XLS.parse_xlscfb(cfb);
	process_wb(wb);
}

function process_wb(wb) {
	var output = "";
	switch(get_radio_value("format")) {
		case "json":
			output = JSON.stringify(to_json(wb), 2, 2);
			break;
		case "form":
			output = to_formulae(wb);
			break; 
		default:
			output = to_csv(wb);
	}
	if(out.innerText === undefined) out.textContent = output;
	//else out.innerText = "fred";//output;
	else out.innerText = output;
}

var drop = document.getElementById('drop');
function handleDrop(e) {
	e.stopPropagation();
	e.preventDefault();
	var files = e.dataTransfer.files;
	var i,f;
	for (i = 0, f = files[i]; i != files.length; ++i) {
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			var data = e.target.result;
			if(typeof Worker !== 'undefined') {
				xlsworker(data, process_wb);
			} else {
				var cfb = XLS.CFB.read(data, {type: 'binary'});
				//var arr = String.fromCharCode.apply(null, new Uint8Array(data));
				//var cfb = XLS.CFB.read(btoa(arr), {type: 'base64'});
				var wb = XLS.parse_xlscfb(cfb);
				process_wb(wb);
			}
		};
		reader.readAsBinaryString(f);
		//reader.readAsArrayBuffer(f);
	}
}

function handleDragover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.dataTransfer.dropEffect = 'copy';
}

if(drop.addEventListener) {
	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
}
function sheet_to_row_object_array_add_headings(sheet, headings){ //column headings are an array of strings to be used as the headings i.e. Row 0
	var val, rowObject, range, columnHeaders, emptyRow, C;
	var outSheet = [];
	if (sheet["!ref"]) {
		range = XLS.utils.decode_range(sheet["!ref"]);

		columnHeaders = {};
		if (headings== "undefined") {
		for (C = range.s.c; C <= range.e.c; ++C) {
			val = sheet[encode_cell({
				c: C,
				r: range.s.r
			})];
			if(val){
				switch(val.t) {
					case 's': case 'str': columnHeaders[C] = JSON.parse(val.v); break;
					case 'n': columnHeaders[C] = val.v; break;
				}
			}
		} } else {
		for (C = 0; C <headings.length; ++C) {
		columnHeaders[C] = headings[C];
		
		  }
		}

		for (var R = range.s.r + 1; R <= range.e.r; ++R) {
			emptyRow = true;
			//Row number is recorded in the prototype
			//so that it doesn't appear when stringified.
			rowObject = Object.create({ __rowNum__ : R });
			for (C = range.s.c; C <= range.e.c; ++C) {
				val = sheet[XLS.utils.encode_cell({
					c: C,
					r: R
				})];
				var v = (val || {}).v;
				if(val !== undefined) switch(val.t){
					case 's': case 'str':
						if(v !== undefined) v = JSON.parse(v);
					/* falls through */
					case 'b': case 'n':
						if(v !== undefined) {
							rowObject[columnHeaders[C]] = v;
							emptyRow = false;
						}
						break;
					case 'e': break; /* throw */
					default: throw 'unrecognized type ' + val.t;
				}
			}
			if(!emptyRow) {
				outSheet.push(rowObject);
			}
		}
	}
	return outSheet;
}
 });
</script>
 <div id="navbox" style='padding:4.35pt 7.95pt 4.35pt 7.95pt;text-align:left;'>
<span id="navtext" ><p>This is in Navbox </p></span>
<button type="button" value="makeCards">Make Cards</button></br>
<button type="button" value="printCards">Print Cards</button>



<br>
<b>JS-XLS Live Demo</b><br />
<input type="radio" name="format" value="csv" checked> CSV<br>
<input type="radio" name="format" value="json"> JSON<br>
<input type="radio" name="format" value="form"> FORMULAE<br>

<div id="drop">Drop an XLS file here to see sheet data.</div>
<!--
<textarea id="b64data">... or paste a base64-encoding here</textarea>
<input type="button" id="dotext" value="Click here to process the base64 text" onclick="b64it();"/>
-->
<br />
</div>
<div class="page-icon grid-pane" frameborder="0" >
grid div<br>
<pre id="out"></pre>

</div>
<iframe class="page-icon preview-pane" frameborder="0" ></iframe>



</body></html>